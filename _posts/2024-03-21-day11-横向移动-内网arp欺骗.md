---
title: day11-横向移动-内网ARP欺骗
date: 2024-03-21 22:48 +0800
categories: [内网,横向移动] 
tags: [横向移动,ARP]
img_path: /img/penetration/
---

## 0x00 介绍与环境准备

我们可以利用ARP攻击对目标进行断网、数据劫持、监听等。

### 1、ARP介绍

ARP（Address Resolution Protocol）是一种TCP/IP协议，用于根据IP地址获取物理地址。当源主机需要将一个数据包发送到目的主机时，会首先检查自己的ARP列表中是否存在该IP地址对应的MAC地址。如果有，就直接将数据包发送到这个MAC地址；如果没有，就向本地网段发起一个ARP请求的广播包，查询此目的主机对应的MAC地址。这个ARP请求数据包里包括源主机的IP地址、硬件地址，以及目的主机的IP地址。网络中所有的主机收到这个ARP请求后，会检查数据包中的目的IP是否和自己的IP地址一致。如果源主机一直没有收到ARP响应数据包，表示ARP查询失败。

> 一般来说，我们处在同一局域网下的机子，需要访问互联网的时候会首先向本网的网段进行请求，然后由本网的路由器进行发送。因此，若我们可以冒充网端来欺骗其他主机的话，那么就可以进行劫持或者断网等等操作了。
{: .prompt-info}

### 2、ARP欺骗原理

由于地址解析是建立在网络中各个主机互相信任的情况下，在局域网中主机可以自行的发布ARP的应答信息，简单来说，如果网络中有其他主机需要自己的mac地址，那么这台主机会主动将自己的mac地址发布出去，而需求主机并不会对该数据报文的真实性进行校验，而是会直接存入自己的ARP缓存中，而这样的情况下就会导致攻击者就可以对某一台主机的ARP应答报进行伪造，从而导致这台主机在进行访问的时候出现报错或者无法通信的情况。

### 3、环境准备

|  设备  |       IP       |
| :----: | :------------: |
| 路由器 |  192.168.31.1  |
|  kali  | 192.168.31.158 |
| iphone | 192.168.31.189 |
|  平板  | 192.168.31.210 |
| 物理机 | 192.168.31.188 |

## 0x01 断网限制-单向

### 1、攻击原理

攻击机伪造数据包后本应该传输给靶机的数据错误的传输给攻击机，使靶机得不到服务器的响应数据，甚至根本无法将数据包发送出局域网。

### 2、攻击过程

这里，我们可以使用任意的能够发送arp数据包的根据即可：（本文将在物理机上使用科莱工具）

[arpspoof工具](https://github.com/alandau/arpspoof/releases/tag/v0.2)

[科莱](https://www.colasoft.com.cn/download/capsa.php)

首先，我们需要探测一下对应靶机的`ip`和`mac`地址：

```cmd
arp -a
```

![截图](c876787ff0056d126498d008c61e36fb.png)

> 如果一开始找不到的话，可以让对应机子ping一下我们的物理机即可）
{: .prompt-waring}

这里我们将用`kali`作为我们的靶机。然后，首先测试了一下正常情况下我们能够正常访问`www.baidu.com`：

![截图](6d477733f1b595f3cc82c3e8fc1f1a89.png)

然后，这时候我们利用科来工具进行arp攻击。 首先，我们在克莱工具中选中arp包发送至生成器中：

![截图](a31de098d858939e94ed92b683e87b59.png)

然后，在这里我们需要进行如下的设置：

```sass
以太网-||
目的地址：000:0C:29:6B:87:56   ##被攻击者MAC地址，这里默认中间是-要替换为:
源地址：随便设置        ##如果设置自己的容易被抓。

地址解析协议
发送者MAC地址：随便设置  ##要和上面的源地址相同。
发送者IP地址：192.168.31.1##写网关
目标MAC地址：00:0C:29:6B:87:56 ##被攻击者MAC地址，这里默认中间是-要替换为:
目标地址：192.168.31.158  ##被攻击者的IP地址
```
{: ."ARP数据包"}

![截图](ba4c2581bc8375af87a81453b6cf2c03.png)

然后，点击发送，并设置网卡，设置0次，也就是无限循环。

![截图](161a6f631c09cbcb610c9e89764976ce.png)

此时，我们就可以看到我们的kali已经无法上网了：

![截图](8ca63010d5ffe08ab4e42f88a2581b1f.png)

![截图](a9ac04f2253bf7b7e64b95f31b0505b2.png)

至此，我们完成了断网的攻击！！！ 

## 0x02 ARP劫持-劫持数据-双向

### 介绍双向劫持

攻击机一直发送伪造的数据包，欺骗网关自己是靶机，欺骗靶机自己是网关，同时开启路由转发功能，就可以让靶机在正常上网的情况下截获网络数据包，所有数据都会经过攻击机再转发给靶机。

简单来说，就是监听靶机的数据流量 ==> 从而获取到一些敏感信息等等。

### 攻击过程

在此我们将利用kali作为攻击机进行劫持其他主机的数据。

#### 开启转发流量

> 这一步在实战中是比较重要的，因为如果你不把kali开启转发的话。那么你劫持的目标机子是无法上网的，自然会容易引起对方的怀疑。
{: .prompt-info}

```bash
echo 1 >> /proc/sys/net/ipv4/ip_forward   
```

#### 开启劫持攻击（针对平板）

```bash
arpspoof -i eth0 -t 192.168.31.210 -r 192.168.31.1
```

-i 指定进行arp攻击的网卡
-t 目标主机IP
-r 进行双向攻击
最后为网关的IP地址

#### 网络协议包查看

这里我们访问我自己的网站。然后用kali自带的wireshark进行查看：

```sass
ip.addr == 192.168.31.210 # 过滤条件
```

![截图](4f7f7906ebcf1cd6fe0ec89ec20c1447.png)

由于这里我们kali是虚拟机，依托于我们物理机的网卡出口。因此，kali上出去的数据也将会被我们物理机扑捉到。然后我们这里用科来进行查看：

![截图](7ab86570749c4252c783cb3f20e1d144.png)

#### 对Iphone攻击

```bash
arpspoof -i eth0 -t 192.168.31.189 -r 192.168.31.1
```

![截图](9e908602192ddd58996905df2f0f3955.png)

#### 截取登录密码

kali安装：

```bash
sudo apt install ettercap-graphical
```

启动：

```bash
ettercap -Tq -i eth0
```

语法：

```markdown
-l	显示可用网卡接口设备
-i	选择接口
-t	协议选择，tcp/udp/all，默认为all
-p	不进行毒化攻击，用于嗅探本地数据包
-L	载入过滤器文件
-V	text 将数据包以文本形式显示在屏幕上
-L	filename 把所有的数据包保存下来（保存后的文件只能用etterlog显示）
```

这里，我们登陆了自己建的一个靶场进行测试：

![截图](c3f5dc00f888382d66bdbe5595d48686.png)

成功捕捉！！！

## 0x03 DNS劫持

我们将利用DNS的解析来进行劫持网内的主机，以此我们就可以制作钓鱼页面，将受害者访问的网址导向我们的钓鱼页面：。

### 1、Windows主机dns命令

```cmd
ipconfig /displaydns  ##查询DNS缓存
ipconfig /flushdns  ##刷新DNS缓存
```

### 2、开启dns劫持

这里我们依旧使用kali作为攻击机。

#### 1）修改配置文件

首先，我们需要修改一下kali中`ettercap`工具的`DNS解析`，确实也就是将流量转发到这个我们自己的网站上：

```bash
vim /etc/ettercap/etter.dns  ##配置文件地址
```

```sass
修改内容：
* A 192.168.31.158      ##星号就代表匹配所有，A就是A记录，192.168.2.10就是kali攻击机的地址，当然你也可以使用公网IP。

其他类型：   ##以下均可以配置，这个是针对性的
www.*.com A 192.168.2.10
*.baidu.com A 192.168.2.10
*.*.com A 192.168.2.10
```
{: ."/etc/ettercap/etter.dns"}

#### 2）开启ettercap

```bash
ettercap -G
```

先扫描主机：

![截图](c22892340bcdee1d7d4f48a9d17f6abe.png)

然后添加主机，将网关添加到目标1，目标主机添加到目标2：

![截图](18f46242020af48e1aeae049cf113685.png)

然后，开启ARP攻击：

![截图](287cfc6f6fc582bc96884ba14854e9ef.png)

选择，dns欺骗插件：

![截图](7678978f704d154e69d889409f5442aa.png)

开启攻击：

![截图](a74c7c0e6b8702a5318fa8ed2a13cc93.png)

然后我们去物理机上访问任意网址：

![截图](7ca24f01230aff1d48b65edddabf4ef2.png)

发现跳转了！！！

## 参考文献

[1] https://blog.csdn.net/weixin_44268918/article/details/1322548

[2] 迪总
