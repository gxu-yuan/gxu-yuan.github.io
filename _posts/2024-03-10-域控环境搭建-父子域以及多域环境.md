---
title: 域控环境搭建-父子域以及多域环境
author: Yuan
date: 2024-03-10 14:55 +0800
categories: [搭建,靶场] 
tags: [父子域]
img_path: /img/AD/
---



## 0x00 环境准备

#### 父子域环境如下：

父域DC ： windows-2016；192.168.40.10； dc.yuan.com；administrator/Admin12345

			个人PC ： Windows-10；192.168.40.20； boss.yuan.com；boss/admin!@#45
	
			内网web： window- 2012 ； 192.168.40.30；sqladmin.yuan.com；sqladmin//admin!@#45
	
			子域DC： windows2016； 192.168.40.40； dc.test.yuan.com；administrator/Admin12345
	
						子域web：windows2012；192.168.40.50； test.test.yuan.com；webadmin//admin!@#45

![环境配置.png](5fb2d344f44cca84bb7e78a90f5d702b.png)

## 0x01 父子域控的搭建

首先根据上述配置下载并安装好所需的主机，然后我们将一步步的进行配置。

#### 0) 改名操作

先给每个计算机进行改名，例如我的dc服务器我就改名为dc，web服务器就改名为web。。。（当然该不该都可以）

```markdown
（在系统属性处就可以改名！！）
```

#### 1）添加虚拟机网卡

点击vmware的`虚拟网络编辑器` --> 点击`添加网络` --> 随机选择一个网卡 --> 设置子ip地址为`192.168.40.0` 

![截图](9623a0424461f0f9d03693d8df6ac403.png)

此后，给每一个主机的`网络适配器`都设置为我们刚刚修改的那个网卡，例如我的就设置为`vmnet2`:

![截图](3bd2b1e60b6fd8963129ff42cff7cabd.png)

<br/>

#### 2）开启父域控DC

首先，在网络适配器处更改本机ip地址为静态的！！！ 这里我设置我的主控dc为`192.168.40.10`：

```markdown
# Windows2016-网络设置
ipv4：192.168.40.10
子网掩码：255.255.255.0
默认网关：192.168.40.1

首选DNS：192.168.40.10
```

1、在windows2016-父dc的主机中的`服务器管理器`中点击`添加角色和功能`；

2、在`服务器角色`处选择`Active Directory域服务`，然后点击下一步；直至安装。

3、然后在`服务器管理器`的左侧栏就会出现`AD DS`的功能，点击进入。 然后再该页面上方会出现个警告提示，然后我们点击更多：

![截图](9413c86bd2a15567f206b91e79d1a916.png)

4、进入后，我们选择将此服务器提升为域控制器；而后进入`AD域服务配置向导`

5、在`部署配置`中选择`添加新林`，然后输入自己想要的根域名：

![截图](681b349bae1fa56ef588fdd3d60335f9.png)

6、输入还原密码；点击下一步

7、输入netbios域名，可以用默认的； 然后一直点击下一步直至安装即可。

此时，电脑将会进行配置并重启。 等待重启完成后，选择登录到域控环境下：（用户名是：域控\administrator)

```markdown
账号与密码：
YUAN\administrator 
Admin12345
```

登录进来后，选择`DNS服务`，然后右击服务器，选择`DNS管理器` --> 点击`dc.yuan.com` --> 点击`正向查找区域` --> 点击`_msdcs.yuan.com` --> 右击属性 --> 点击`区域传送` --> 勾选`允许区域传送`：

![截图](41217b8e8b9aabff38f5b680db82dc12.png)

然后，我们继续选择`AD DS`服务右击服务器，选择`用户和计算机`，点击`Users`，进行创建角色：（注意，密码这里最好取消掉`用户下次登陆时必须更改密码`这个选项，以及勾选`密码永不过期`选项，方便后续的渗透利用）

```markdown
boss/admin!@#45
sqladmin/admin!@#45
```

然后是，这两台计算机申请加入即可。

#### 3）Windows10、Windows2012加入域环境

设置本机网络环境：

```markdown
# Windows10-boss-网络设置
ipv4：192.168.40.20
子网掩码：255.255.255.0
默认网关：192.168.40.1

首选DNS：192.168.40.10
```

然后，右击`此电脑的属性`，然后在`计算机名、域和工作组`处点击更改设置；点击更改此计算机的域，然后输入我们的域控域名：

![截图](eaba0d9d4bb7c56b51c483caf4d9c2cc.png)

然后输入用户与密码：（此处需要输入我们之前创建的密码即可）

```markdown
boss/admin!@#45
```

此时，就已经加入域控了。（需要重启）

同理，我们设置Windows2012的网络配置如下：

```markdown
# Windows10-sql-网络设置
ipv4：192.168.40.30
子网掩码：255.255.255.0
默认网关：192.168.40.1

首选DNS：192.168.40.10
```

然后加入的操作同上，用户与密码是：

```
sqladmin/admin!@#45
```

此时，在主域控机器上就出现了我们加入的两台主机：

![截图](100e6fc5e13e475aeff6aed81846aef7.png)

#### 4）子域控dc的加入

```markdown
# Windows2016-子域控-网络设置
ipv4：192.168.40.40
子网掩码：255.255.255.0
默认网关：192.168.40.1

首选DNS：192.168.40.10
```

这里我们将和第二部分的安装域控一样，先给子域控主机配置域控的服务先。

然后在`域服务配置向导`这个地方我们在部署时候需要选择`将域添加到现有林`这个选项：

并输入父域控的域名和子域控的域名：（父域控这里我们需要点击选择，然后输入父域控的管理员账号）

```markdown
YUAN\administrator
Admin12345
```

![截图](bf0a57fd68fafb8b65d2bec2b6e795c2.png)

之后，也像前面一样配置就行了（默认配置就行了）

> 如果报错信息如下：
>
> 操作失败的原因是:
>
> 安全帐户管理器(SAM)确定了此计算机的安全标识符(SID)已用于要加入的林。当使用不正确的备份还原 Active Directory 域控制器时可能会发生这种情况。在本地 AD DC 上重新安装操作系统以获取新 SID。
>
> “指定的域已存在。”
>
> 则说明：我们在创建该虚拟机时候直接是复制了父DC的机子，因此导致SID值一样。 这里我们需要进行一下更改：
>
> 1、按下`win+r`，然后在运行框中输入sysprep；
>
> 2、运行sysprep;
>
> 3、然后在系统准备工具页面选中OOBE和通用，确认后重新启动即可进入到新的系统准备页面，等待完成之后即可
{: .prompt-warning}

此时，在父域控dc的`域和信任关系`中，我们就可以看到子域控的出现了：

![截图](b41ced2633860c62295def9b60bedb76.png)

除此之外，我们还需要在子域控上加入web的用户：

```markdown
web\admin!@#45
```

#### 5）外网web服务器加入子域控中

```markdown
# Windows2012-外网web-网络设置
ipv4：192.168.40.50
子网掩码：255.255.255.0
默认网关：192.168.40.1

首选DNS：192.168.40.40
```

> 这里我们的web直接连接的是子域控的主机，因此DNS要修改为子域控的ip
{: .prompt-info}

这里，我们选择加入的域名应该选择子域控的域名：`test.yuan.com`

而后输入web的账户即可。
